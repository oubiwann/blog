<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en" class="no-js"> <!--<![endif]-->
  
  
  
  <head profile="http://dublincore.org/documents/dcq-html/">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1179318-5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-1179318-5');
    </script>
    <meta charset="utf-8">
    <title>
    
      oubiwann | blog
      
      
      
    
    </title>
    

    
    
    
    <!-- General Metadata (site-wide) -->
    <meta name="description" content="A 21st century .plan for Duncan McGreggor">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="oubiwann | blog: version 5.0.0-SNAPSHOT, build 38c457a

">

    <!-- Google Metadata -->
    <meta name="google-site-verification" content="w0pQqmlRRJk36_i3se1w2U7qwG8kS_VqiLS2hq5Wk7g" />

    <!-- Dublic Core Metadata (site-wide) -->
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
    <link rel="schema.DCTERMS" href="http://purl.org/dc/terms/">
    <meta name="DC.format" scheme="DCTERMS.IMT" content="text/html">
    <meta name="DC.type" scheme="DCTERMS.DCMIType" content="Text">
    <meta name="DC.coverage" content="2003-2019">
    <meta name="DC.rights" content="Creative Commons Attribution-ShareAlike 4.0 International License">
    <meta name="DC.publisher" content="C&amp;B|Books">
    <meta name="DCTERMS.audience" content="Developers, Software Engineers, Computer Scientists, Technologists, Programmers, Programming Language Enthusiasts, Operational Engineers">

    
    
<!-- General Metadata (per-page) -->
<meta name="author" content="">

<!-- Dublic Core Metadata (per-page) -->
<meta name="DC.title" lang="en" content="Creating LFE Servers with OTP, Part I">
<meta name="DC.creator" content="oubiwann">
<meta name="DC.subject" content="LFE">
<meta name="DC.date" content="2015-05-26">
<meta name="DC.identifier" scheme="DCTERMS.URI" content="https://oubiwann.github.io/blog/archives/2015-05/26-111208/creating-lfe-servers-with-otp-part-i.html">
<meta name="DCTERMS.abstract" content="Creating a generic OTP server in LFE">

<!-- Facebook's OpenGraph Metadata -->
<meta property="og:site_name" content="o|b">
<meta property="og:title" content="Creating LFE Servers with OTP, Part I">
<meta property="og:url" content="https://oubiwann.github.io/blog/archives/2015-05/26-111208/creating-lfe-servers-with-otp-part-i.html">
<meta property="og:type" content="blog">
<meta property="og:description" content="Creating a generic OTP server in LFE">
<meta property="og:image" content="https://oubiwann.github.io/blog/img/ob-post-3.jpg">
<meta property="article:author" content="">
<meta property="article:published_time" content="2015-05-26 11:12:08">
<meta property="article:modified_time" content="">
<meta property="og:updated_time" content="">
<meta property="article:section" content="LFE">


<!-- Twitter Card Metadata -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site:id" content="@oubiwann">
<meta name="twitter:creator:id" content="@ErlangLisp">
<meta name="twitter:title" content="Creating LFE Servers with OTP, Part I">
<meta name="twitter:url" content="https://oubiwann.github.io/blog/archives/2015-05/26-111208/creating-lfe-servers-with-otp-part-i.html">
<meta name="twitter:description" content="<p><p><a href="/assets/images/posts/LFE-signal.jpg"><img class="right thumb" src="/assets/images/posts/LFE-signal.jpg" /></a>As mentioned in the previous post, one of the most common patterns that was identified in Erlang was the need ...</p>">
<meta name="twitter:image" content="https://oubiwann.github.io/blog/img/ob-post-3.jpg">

    
    

    <link rel="alternate" type="application/atom+xml" title="Feed" href="/blog/atom.xml" />
    

    <!-- Webfonts Setup /-->
    <link href="https://fonts.googleapis.com/css?family=Maitree&amp;subset=latin-ext"
          rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Yantramanav&amp;subset=latin-ext"
          rel="stylesheet" type="text/css">

    <!-- Bootstrap/Custom Styles Setup /-->
    <link rel="stylesheet" href="/blog/assets/highlightjs/styles/arta.css" type="text/css">
    <link rel="stylesheet" href="/blog/assets/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/blog/assets/bootswatch/css/custom.min.css" rel="stylesheet" type="text/css" id="theme">
    <link rel="stylesheet" href="/blog/css/theme.css" rel="stylesheet" type="text/css" id="theme" media="screen">

    <!-- Favicon Setup /-->
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/icons/apple-touch-icon.png?v=3">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/icons/favicon-32x32.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="/blog/icons/favicon-16x16.png?v=3">
    <link rel="manifest" href="/blog/icons/manifest.json?v=3">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg?v=3" color="#5bbad5">
    <link rel="shortcut icon" href="/blog/icons/favicon.ico?v=3">
    <meta name="apple-mobile-web-app-title" content="FRMX">
    <meta name="application-name" content="o|b">
    <meta name="msapplication-config" content="/blog/icons/browserconfig.xml?v=3">
    <meta name="theme-color" content="#ffffff">
    
    
    
    
    
  

  </head>
  
  <body>
  
   
    <header class="tiny">
      
<div class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
  <div class="container">
    <div class="navbar-brand-wrapper">
      <a href="/blog/" class="navbar-brand">o|b</a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

   <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/blog/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/archives">Archives</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/categories">Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/tags">Tags</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/authors">Authors</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="about">About <span class="caret"></span></a>
          <div class="dropdown-menu" aria-labelledby="about">
            <a class="dropdown-item" href="/blog/about/">The Blog</a>
            <a class="dropdown-item" href="/blog/about/contact/">Contact Us</a>
            <a class="dropdown-item" href="/blog/about/powered-by/">Powered By</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/blog/about/license/">License</a>
          </div>
        </li>
      </ul>

      <ul class="nav navbar-nav ml-auto social-nav">
        <li class="nav-item">
          <a href="/blog/atom.xml" alt="Atom Feed">
            <i class="fa fa-feed first"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://twitter.com/oubiwann" alt="Twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="/googleplus" alt="Google+">
            <i class="fa fa-google-plus"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="http://github.com/oubiwann" alt="Github">
            <i class="fa fa-github"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://groups.google.com/forum/#!forum/oubiwann-blog-new-posts"
             alt="Email Notifications">
            <i class="fa fa-envelope"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

    </header>
    
    
    <main id="main-content">
      

    <!-- Page Content -->
    <div class="container page-content">

      <div class="row">

        <!-- Post Content Column -->
        <div class="col-lg-12">

          <!-- Title -->
          <h1 class="mt-4">Creating LFE Servers with OTP, Part I</h1>

          <!-- Author -->
          <p class="lead">
            Posted on May 26,
            2015 by
            <a href="/blog/authors#oubiwann">oubiwann</a>
          </p>

          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link show active" data-toggle="tab" href="#content">Content</a>
            </li>
            <li class="nav-item">
              <a class="nav-link show" data-toggle="tab" href="#metadata">Metadata</a>
            </li>
          </ul>

          <br/>

          <div id="post-content" class="tab-content">
            <div class="tab-pane fade active show" id="content">

          <!-- Post Image -->
          <img class="card-img-top" src="/blog/img/ob-post-3.jpg" alt="Blog post image">

          <hr>

          <!-- Post Content -->
          <p><a href="/assets/images/posts/LFE-signal.jpg"><img class="right thumb" src="/assets/images/posts/LFE-signal.jpg" /></a>As mentioned in the previous post, one of the most common patterns that was identified in Erlang was the need to create a generic, long running process. This pattern has been codified in the gen_server behaviour, and it is now time that we got our hands dirty by creating a few :-)</p><h2>LFE OTP Tutorial Series</h2><ul><li><a href='/tutorials/2015/05/23/1720-new-series-lfe-otp-tutorials/'>Introducing the LFE OTP Tutorials</a></li><li><a href='/tutorials/2015/05/24/1808-what-is-otp/'>What is OTP?</a></li><li><a href='/tutorials/2015/05/25/0929-prelude-to-otp/'>Prelude to OTP</a></li><li><a href='/tutorials/2015/05/26/1112-creating-servers-with-the-gen_server-behaviour/'>Creating LFE Servers with OTP, Part I</a></li><li><a href='/tutorials/2015/05/28/1008-creating-servers-with-the-gen_server-behaviour-ii/'>Creating LFE Servers with OTP, Part II</a></li><li><a href='/tutorials/2015/09/18/1604-distributed-lfe/'>Distributed LFE</a></li></ul><p>You can leave feedback for the LFE OTP tutorials <a href='https://github.com/lfe/blog/issues/7'>here</a>.</p><h2>In This Post</h2><ul><li>Requirements, Assumptions, and Code</li><li>How We're Going to Do This<ul><li>About ``gen_server``</li><li>OTP Boilerplate</li><li>``gen_server`` in Two Parts</li></ul></li><li>Creating a Callback Module</li><li>Creating a Server Module</li><li>Creating An API</li><li>Updating An API</li><li>Full Source Code</li><li>Up Next</li></ul><h2>Requirements, Assumptions, and Code</h2><p>Before reading this tutorial, be sure you have read the ones preceding it in this series. For a list of what you need to have installed before working through the examples as well as getting the source code for these tutorials, please see the post <a href='/tutorials/2015-05-25-0929-prelude-to-otp/'>Prelude to OTP</a>, in particular the sections "Requirements and Assumptions" and "Getting the Code".</p><p>Once you have the source code cloned to a working directory, you can compile the source and start up the LFE REPL with the following:</p><pre><code class="bash">$ cd ../tut01
$ make repl
</code></pre><h2>How We're Going to Do This</h2><h3>About ``gen_server``</h3><p>The ``gen_server`` behaviour defines a contract between the programmer and the world of OTP, expecting you to do the following:</p><ul><li>Define a module which implements ``gen_server`` functions</li><li>Define a callback module which implements the required message-passing (and  callback-related) functions</li></ul><p>In return for following these rules, you get an infinitely flexible server with some amazing capabilities: fault-tolerance, the capacity to handle an incredible number of simultaneous connections, [<sup>yaws-benchmarks]</sup> and the ability to scale across many cores or many servers.</p><h3>OTP Boilerplate</h3><p>If you have ever looked at Erlang code for ``gen_server``s or other OTP behaviour implementations, you will have noticed that setting up a ``gen_server`` involves some boilerplate Erlang data structures. Newcomers often shake their heads (or even complain loudly!) about the need for so much awkward data. Once you get used to it, it's really not a big deal. And, again, the benefits of using OTP &ndash; and the massive time-savings that go hand-in-hand with those &ndash; far out-weigh the minor inconvenience. You know this immediately when using OTP, if you have ever had to implement production-ready custom servers in other programming languages or frameworks.</p><p>Perhaps the bit that it most cumbersome for new OTP developers is the fact that, due to the lack of keyword arguments in Erlang (and the tendency for older Erlang code not to use <a href='http://learnyousomeerlang.com/a-short-visit-to-common-data-structures#key-value-stores'>property lists</a> as a way around this), reading the implementations for the various OTP behaviours can be a bewildering and frustrating experience.</p><p>We are not going to following the Erlang idiom in the LFE tutorials below: we're going to define variables for all the parameters so that you may more easily decipher what's happening when you read the code.</p><h3>``gen_server`` in Two Parts</h3><p>When teaching OTP to new programmers and even seasoned programmers new to Erlang, I often get questions like the following:</p><ul><li>Why do I have to type the module name so many times?</li><li>What is the different between callback and server modules?</li><li>Which one am I writing now?</li><li>Why is the documentation for them in two different places?</li><li>Why do I put them in a single file?</li></ul><p>These questions may not make sense right now, but they will by the time you finish the tutorial for this post! Hopefully, though, the approach we have decided to take will not leave you frustrated, but instead the proud holder of new knowledge and insight.</p><p>In particular, we're are again going to follow a non-traditional route, and for Part I of the ``gen_server`` tutorial we will be splitting our code across two modules. Furthermore, we will only do a partial implementation of ``gen_server`` in this part.</p><p>In Part II, we will migrate our two-module code to a single, integrated module which a complete implementation of ``gen_server``. In the process, we hope to answer any lingering questions about the "how" and "why" of ``gen_server``.</p><p>That said, we're ready for some code!</p><h2>Creating a Callback Module</h2><p>Let's take a quick look back at our process server from the previous post:</p><pre><code class="lisp">&#40;defun process-state &#40;caller state-data&#41;
  &#40;receive
    &#40;'inc
      &#40;process-state caller &#40;+ 1 state-data&#41;&#41;&#41;
    &#40;'amount?
        &#40;! caller state-data&#41;
        &#40;process-state caller state-data&#41;&#41;&#41;&#41;
</code></pre><p>This code combines two aspects:</p><ul><li>the server: the functionality provided by calling ``(receive ...)`` and waiting  for matching messages, and</li><li>the logic: the code that gets executed when a message matches either ``add``  or ``amount?``</li></ul><p>The most obvious bit, and the bulk of the code, is in the logic, so let's port that to OTP first. This code will be put in a "callback" module, something which our new OTP server will make use of. We'll discuss this more shortly, but for now here's what our logic looks when ported to ``gen_server`` callbacks:</p><pre><code class="lisp">&#40;defun handle&#95;cast
  &#40;&#40;'increment state-data&#41;
    `#&#40;noreply ,&#40;+ 1 state-data&#41;&#41;&#41;&#41;

&#40;defun handle&#95;call
  &#40;&#40;'amount &#95;caller state-data&#41;
    `#&#40;reply ,state-data ,state-data&#41;&#41;
  &#40;&#40;message &#95;caller state-data&#41;
    `#&#40;reply ,&#40;unknown-command&#41; ,state-data&#41;&#41;&#41;
</code></pre><p>If we compare this to the process server from the previous post, we can see that things have started to change rather significantly. First of all, our callback module has two functions instead of just one: ``handle_cast`` and ``handle_call``. These functions are not used by developers or users of the OTP software we write; they are defined in a callback module for use by our ``gen_server``. Let this sit for now &ndash; we'll come back to it shortly. Let's keep looking at this code:</p><p>The ``handle_call`` function is used for making synchronous calls, usually where a result is expected. This is why we return the ``#(reply ...)`` tuple: we’re letting OTP know that whatever made this call should get the second element of the tuple sent to it (in this case, the ``state-data``). The third element of the tuple is used internally by ``gen_server`` as the state data used when restarting the loop after this call (all under the hood and away from view). We did something almost identical in our process example in the last post: whenever we needed to restart the loop, we passed it the updated state data. [<sup>return-and-state-same]</sup></p><p>Note the reply of ``(unknown-command)`` in the catch-all function head pattern for ``handle_call``. This is used here for demonstration purposes only. In Part II of this post we will cover error handling and how to best deal with unexpected messages in a ``gen_server``.</p><p>The ``handle_cast`` function is used for making asynchronous calls, often convenient when you want to execute a function and don’t care about returning data to the caller. This is exactly what we’re using it for: we just want our state data to get incremented; we don’t want a result.</p><p>Both functions expect a message (any Erlang term) and the state data for our ``gen<i>server`` loop. Additionally, the ``handle</i>call`` function takes a parameter for the calling function so that it can send results back to it. When we look at the the API code in our server module, we’ll see where this code gets called.</p><p>The other thing our callback module needs to define is an ``init`` function. This is used to “prime the pump”, as it were, for the the ``gen_server`` loop. In other words, this is what initializes the state that gets passed to the various ``handle_*`` functions. Note that for our example, our state data is extremely simple: it’s just an integer. But it could be any LFE data structure, including records (which is very often what the state data is in Erlang and LFE applications).</p><h2>Creating a Server Module</h2><p>Okay, so we know how our logic gets converted from the non-OTP server loops to the callback code ... but what calls the callback? If we’re creating a server in this post then where is the server code? Thanks to OTP (which takes care of so many of the details), our server code is very simple:</p><pre><code class="lisp">&#40;defun start &#40;&#41;
  &#40;gen&#95;server:start &#40;register-name&#41;
                    &#40;callback-module&#41;
                    &#40;initial-state&#41;
                    &#40;genserver-opts&#41;&#41;&#41;
</code></pre><p>As we promised earlier, instead of arcane data structures, we have very clearly defined the variables which are being used as the ``gen_server:start`` arguments. The source code for this tutorial defines those at the top of the ``tut01-server`` module: [<sup>genserver-args]</sup></p><pre><code class="lisp">&#40;defun server-name &#40;&#41; &#40;MODULE&#41;&#41;
&#40;defun callback-module &#40;&#41; 'tut01-callback&#41;
&#40;defun initial-state &#40;&#41; 0&#41;
&#40;defun genserver-opts &#40;&#41; '&#40;&#41;&#41;
&#40;defun register-name &#40;&#41; `#&#40;local ,&#40;server-name&#41;&#41;&#41;
</code></pre><p>Let's address each of the four items that were passed to the ``gen_server:start`` function:</p><ol><li>We passed a name with which the server will be   registered. [<sup>start-name]</sup> The name is a tuple with the first element being   either ``local`` or ``global`` and the second being the actual name for the   process. [<sup>via-name]</sup> In our case, we're just using the module name   to name the server.</li><li>The second argument is the callback module associated with this server.   That's what we created in the previous section; it's where all our logic   lives.</li><li>In our case, the next argument is the initial state for our server loop, but   more generally, this is where you (indirectly) pass arguments to the   ``init`` function you have defined in your ``gen_server``'s callback module.</li><li>Finally, if we want to pass any options to the ``gen_server`` process   itself, we can do that here. We've defined ``(genserver-opts)`` to be an   empty list, since we don’t need to do anything special here. [<sup>genserver-opts]</sup></li></ol><p>The full listing of the source code for our server and callback modules is given at the end of this post, if you'd like to see what we've talked about so far the their full context.</p><h2>Creating An API</h2><p>Next we will look at our server API. As you recall from the last post, our “APIs” were hardly that. They consisted of making ``funcall``s in one case, and in the other, sending messages to the server process via the ``(! ...)`` form. That changes now :-)</p><p>Whenever you have created an implementation of the ``gen_server`` behaviour (and its associated callback module), you can execute the callback code by sending messages to your server via ``(gen_server:call ...)`` and ``(gen_server:cast ...)``. We will use these to define a nicely usable API for our server:</p><pre><code class="lisp">&#40;defun inc &#40;&#41;
  &#40;gen&#95;server:cast &#40;server-name&#41; 'increment&#41;&#41;

&#40;defun amount? &#40;&#41;
  &#40;gen&#95;server:call &#40;server-name&#41; 'amount&#41;&#41;
</code></pre><p>You can imagine that for a large server module, there would be a great many API functions defined here.</p><p>How this works is you call these functions, then ``gen_server`` looks up the callback module which has been defined for the given server. It then passes the given message (in our case either ``increment`` or ``amount``). If ``gen<i>server:cast`` was used to pass the message, then ``handle</i>cast`` will be called in the callback module; if ``call`` was used, then ``handle_call`` will be called.</p><p>Let’s try it out:</p><pre><code class="lisp">&gt; &#40;tut01-server:start&#41;
#&#40;ok &lt;0.35.0&gt;&#41;
&gt; &#40;tut01-server:inc&#41;
ok
&gt; &#40;tut01-server:inc&#41;
ok
&gt; &#40;tut01-server:amount?&#41;
2
&gt; &#40;tut01-server:inc&#41;
ok
&gt; &#40;tut01-server:amount?&#41;
3
&gt; &#40;gen&#95;server:call &#40;tut01:server-name&#41; 'bingo&#41;
#&#40;error &quot;Unknown command.&quot;&#41;
</code></pre><p>How’s <em>that</em> for clean! That’s what a good developer experience should look like :-) None of this crazy you-gotta-make-``funcall``s-and-then-save-state business.</p><p>Let's go over what happened above:</p><ul><li>We started up our server.<ul><li>This initialized the loop with the function from the callback module.</li><li>But remember: the ``init`` function gets its argument from what we passed    to ``gen_server:start``, ``0`` in our case.</li></ul></li><li>We made some API calls &ndash; these were passed on to our callback module by  the underlying OTP infrastructure.</li><li>We got results for our API functions which made ``call``s.</li><li>We got a simple and reassuring ``ok`` for our API functions which make  ``cast``s.</li><li>When we skipped the API functions and passed an unexpected message to our  callbacks directly via ``gen_server:call``, we got the error we defined for  unknown messages.</li></ul><h2>Updating An API</h2><p>What if we needed to make a change to our API? Asked another way, what does one need to do in order to add new functionality to a server API? Let’s answer this by adding a decrement capability to our simple server. We'll start by updating the API:</p><pre><code class="lisp">&#40;defun dec &#40;&#41;
  &#40;gen&#95;server:cast &#40;server-name&#41; 'decrement&#41;&#41;
</code></pre><p>That’s the the API function we'll be calling. Now let’s add support for the new ``decrement`` message that it will be sending to ``handle_cast`` in the callback module:</p><pre><code class="lisp">&#40;defun handle&#95;cast
  &#40;&#40;'increment state-data&#41;
    `#&#40;noreply ,&#40;+ 1 state-data&#41;&#41;&#41;
  &#40;&#40;'decrement state-data&#41;
    `#&#40;noreply ,&#40;- state-data 1&#41;&#41;&#41;&#41;
</code></pre><p>Let's make sure these work as expected:</p><pre><code class="lisp">&gt; &#40;tut01-server:start&#41;
#&#40;ok &lt;0.35.0&gt;&#41;
&gt; &#40;tut01-server:inc&#41;
ok
&gt; &#40;tut01-server:amount?&#41;
1
&gt; &#40;tut01-server:dec&#41;
ok
&gt; &#40;tut01-server:dec&#41;
ok
&gt; &#40;tut01-server:amount?&#41;
-1
</code></pre><p>It may seem odd that we've got two distinct bits of code that need to be updated when when an API is added, but it's really just one: the logic in the callback module. The server API is syntactic sugar for a better developer experience; everything will function just fine without it. But you wouldn't want to do that to your developers, right?</p><h2>Full Source Code</h2><p>The full source code for this tutorial is in the repo you have checked out. However, it is nice to see the code in the same context as the blog post, so we've pasted it below.</p><p>Here is the server module:</p><pre><code class="lisp">&#40;defmodule tut01-server
  &#40;behaviour gen&#95;server&#41;
  &#40;export all&#41;&#41;

;;; config functions

&#40;defun server-name &#40;&#41; &#40;MODULE&#41;&#41;
&#40;defun callback-module &#40;&#41; 'tut01-callback&#41;
&#40;defun initial-state &#40;&#41; 0&#41;
&#40;defun genserver-opts &#40;&#41; '&#40;&#41;&#41;
&#40;defun register-name &#40;&#41; `#&#40;local ,&#40;server-name&#41;&#41;&#41;

;;; gen&#95;server implementation

&#40;defun start &#40;&#41;
  &#40;gen&#95;server:start &#40;register-name&#41;
                    &#40;callback-module&#41;
                    &#40;initial-state&#41;
                    &#40;genserver-opts&#41;&#41;&#41;

;;; our server API

&#40;defun inc &#40;&#41;
  &#40;gen&#95;server:cast &#40;server-name&#41; 'increment&#41;&#41;

&#40;defun dec &#40;&#41;
  &#40;gen&#95;server:cast &#40;server-name&#41; 'decrement&#41;&#41;

&#40;defun amount? &#40;&#41;
  &#40;gen&#95;server:call &#40;server-name&#41; 'amount&#41;&#41;
</code></pre><p>And here’s the callback module code:</p><pre><code class="lisp">&#40;defmodule tut01-callback
  &#40;export all&#41;&#41;

;;; config functions

&#40;defun unknown-command &#40;&#41; #&#40;error &quot;Unknown command.&quot;&#41;&#41;

;;; callback implementation

&#40;defun init &#40;initial-state&#41;
  `#&#40;ok ,initial-state&#41;&#41;

&#40;defun handle&#95;cast
  &#40;&#40;'increment state-data&#41;
    `#&#40;noreply ,&#40;+ 1 state-data&#41;&#41;&#41;
  &#40;&#40;'decrement state-data&#41;
    `#&#40;noreply ,&#40;- state-data 1&#41;&#41;&#41;&#41;

&#40;defun handle&#95;call
  &#40;&#40;'amount &#95;caller state-data&#41;
    `#&#40;reply ,state-data ,state-data&#41;&#41;
  &#40;&#40;message &#95;caller state-data&#41;
    `#&#40;reply ,&#40;unknown-command&#41; ,state-data&#41;&#41;&#41;

&#40;defun terminate &#40;&#95;reason &#95;state-data&#41;
  'ok&#41;
</code></pre><p>Note that our callback module doesn’t implement all the callbacks it would need as part of a full-blown OTP application; we’ll address much of that in the next post.</p><p>Also, we've taken the easy way out for exports (and this is generally frowned upon): we don't explicitly state which functions we consider public and should be exported (leaving private functions un-exported). We're trying to keep Part I very simple so that the concepts don't get lost in the details.</p><h2>Up Next</h2><p>The next post will carry on with ``gen_server``, updating it to handle errors in a better way and fixing it to reflect the best practices and community conventions.<h2></h2></p><h3>Footnotes</h3><p>[<sup>yaws-benchmarks]:</sup> In 2008, The Erlang webserver YAWS was compared to Apache,<pre><code>demonstrating its capacity to handle over 80,000 concurrent client
connections while Apache died at about 4,000. You can view an archived
version of the report for the benchmark
&#91;here&#93;&#40;https://www.sics.se/&#126;joe/apachevsyaws.html&#41;. </code></pre>[<sup>return-and-state-same]:</sup> Note that in this simple example, our<pre><code>return value and our state data are one and the same. In a more complicated
example, one might extract the result from the state data or perform some
operations on the state data.  Whatever you did, you would put the result
you wanted to send back to the caller in the second element of the tuple,
and the updated &#40;or sometimes unchanged&#41; state data you'd put in the third
element of the tuple. </code></pre>[<sup>start-name]:</sup> In general, this is optional &ndash; you could use ``start/3`` which<pre><code>doesn't take a name. In our case, however, we need it so that we can easily
make calls to the ``gen&#95;server`` process. For that we need to register a
name so the process can be looked up; if we didn’t do this, we’d need to
keep track of the process id for our server. </code></pre>[<sup>via-name]:</sup> A third alternative is more rarely used in the cases where one<pre><code>needs to implement a custom global registry. In that event, you create a
3-tuple where the second element is the name of the module which implements
the registry functions. </code></pre>[<sup>genserver-opts]:</sup> For a list of available options, see the<pre><code>&#91;gen&#95;server:start docs&#93;&#40;http://www.erlang.org/doc/man/gen&#95;server.html#start-4&#41;. </code></pre>[<sup>genserver-args]:</sup> There is no defined convention in LFE for how one sets up<pre><code>module-level configuration variables or where these might go: you can put
the data for the argument values anywhere it makes sense to you.  You don't
even have to define any -- you can just pass the data as-is in the function
arguments.  However, there is a lot to be said for the readability of the
approach we have taken. </code></pre></p>

            </div>
            <div class="tab-pane fade" id="metadata">

              <table class="table table-hover">
                <tbody>
                  <tr class="table-secondary">
                    <th scope="row">Author</th>
                    <td>oubiwann</td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Date</th>
                    <td>May 26,
        2015</td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Time</th>
                    <td>11:12:08</td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Category</th>
                    <td>
                        <a href="/blog/categories/#LFE">LFE</a>
                    </td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Tags</th>
                    <td>
                      
                      <a href="/blog/tags/#erlang">erlang</a>
                      
                      <a href="/blog/tags/#otp">otp</a>
                      
                      <a href="/blog/tags/#tutorials">tutorials</a>
                      
                    </td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Line&nbsp;Count</th>
                    <td>123 </td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Word&nbsp;Count</th>
                    <td>2664 </td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Character&nbsp;Count</th>
                    <td>21005 </td>
                  </tr>
                </tbody>
              </table>

            </div>
          </div>

          <hr>

          <!-- Comments Note -->
          <div class="card my-4">
            <h5 class="card-header">Comments?</h5>
            <div class="card-body">
              This blog doesn't use standard (embedded) comments; however, since
              the site is hosted on Github, if there <emphasis>is</emphasis>
              something you'd like to share, please do so by
              <a href="https://github.com/oubiwann/blog/issues/new">opening a
              "comment" ticket!</a>
            </div>
          </div>

        </div>

      </div>
      <!-- /.row -->

    </div>
    <!-- /.container -->

<!-- End main page content -->

    </main>
    
    
    <footer id="footer">
      
        <div class="row">
          <div class="col-lg-6">

            <ul class="list-unstyled">
              <li class="text-muted">Blogs</li>
              <li><a href="http://oubiwann.blogspot.com">Electric Duncan</a></li>
              <li><a href="http://blog.lfe.io/">LFE Blog</a></li>
              <li><a href="http://clojang.lfe.io/">Clojang</a></li>
              <li><a href="https://clozhang.github.io/blog/">Clozhang</a></li>
            </ul>

          </div>
          <div class="col-lg-6">
            <ul class="list-unstyled">
              <li class="float-lg-right text-muted">Github orgs</li>
              <li class="float-lg-right"><a href="https://github.com/erlsci">erlsci</a></li>
              <li class="float-lg-right"><a href="https://github.com/lfex">lfex</a></li>
              <li class="float-lg-right"><a href="https://github.com/clozhang">clozhang</a></li>
              <li class="float-lg-right"><a href="https://github.com/clojang">clojang</a></li>
              <li class="float-lg-right"><a href="https://github.com/clojusc">clojusc</a></li>
              <li class="float-lg-right"><a href="https://github.com/hexagram30">hexagram30</a></li>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-6">
          </div>
          <div class="col-lg-6">
            <ul class="list-unstyled">

              <li class="float-lg-right"><a href="https://github.com/masteringmatplotlib">masteringmatplotlib</a></li>
              <li class="float-lg-right"><a href="https://github.com/usgs-lcmap">usgs-lcmap</a></li>
              <li class="float-lg-right"><a href="https://github.com/nasa-ngap-archives">nasa-ngap-archives</a></li>
              <li class="float-lg-right"><a href="https://github.com/nasa-cmr-archives">nasa-cmr-archives</a></li>

            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-12">
            <p><a href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png">
            </a></p>
            <p class="text-muted">Content released under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License.</a>.</p>
            <p class="text-muted">Copyright &copy; Duncan McGreggor, 2003-2019</p>
          </div>
        </div>


    </footer>
    
    
    <script src="/blog/assets/jquery/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/popper.js/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/bootstrap/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/bootswatch/js/custom.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/highlightjs/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
  
  </body>
</html>
