<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en" class="no-js"> <!--<![endif]-->
  
  
  
  <head profile="http://dublincore.org/documents/dcq-html/">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1179318-5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-1179318-5');
    </script>
    <meta charset="utf-8">
    <title>
    
      oubiwann | blog
      
      
      
    
    </title>
    

    
    
    
    <!-- General Metadata (site-wide) -->
    <meta name="description" content="A 21st century .plan for Duncan McGreggor">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="oubiwann | blog: version 5.0.0-SNAPSHOT, build 19fc82f

">

    <!-- Google Metadata -->
    <meta name="google-site-verification" content="w0pQqmlRRJk36_i3se1w2U7qwG8kS_VqiLS2hq5Wk7g" />

    <!-- Dublic Core Metadata (site-wide) -->
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
    <link rel="schema.DCTERMS" href="http://purl.org/dc/terms/">
    <meta name="DC.format" scheme="DCTERMS.IMT" content="text/html">
    <meta name="DC.type" scheme="DCTERMS.DCMIType" content="Text">
    <meta name="DC.coverage" content="2003-2019">
    <meta name="DC.rights" content="Creative Commons Attribution-ShareAlike 4.0 International License">
    <meta name="DC.publisher" content="C&amp;B|Books">
    <meta name="DCTERMS.audience" content="Developers, Software Engineers, Computer Scientists, Technologists, Programmers, Programming Language Enthusiasts, Operational Engineers">

    
    
<!-- General Metadata (per-page) -->
<meta name="author" content="">

<!-- Dublic Core Metadata (per-page) -->
<meta name="DC.title" lang="en" content="Async in Clojure: Playing with Agents, Part II">
<meta name="DC.creator" content="oubiwann">
<meta name="DC.subject" content="">
<meta name="DC.date" content="2012-10-30">
<meta name="DC.identifier" scheme="DCTERMS.URI" content="https://oubiwann.github.io/blog/archives/2012-10/30-132208/async-in-clojure-playing-with-agents-part-ii.html">
<meta name="DCTERMS.abstract" content="">

<!-- Facebook's OpenGraph Metadata -->
<meta property="og:site_name" content="o|b">
<meta property="og:title" content="Async in Clojure: Playing with Agents, Part II">
<meta property="og:url" content="https://oubiwann.github.io/blog/archives/2012-10/30-132208/async-in-clojure-playing-with-agents-part-ii.html">
<meta property="og:type" content="blog">
<meta property="og:description" content="">
<meta property="og:image" content="https://oubiwann.github.io/blog/img/ob-post-6.jpg">
<meta property="article:author" content="">
<meta property="article:published_time" content="2012-10-30 13:22:08">
<meta property="article:modified_time" content="">
<meta property="og:updated_time" content="">
<meta property="article:section" content="">


<!-- Twitter Card Metadata -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site:id" content="@oubiwann">
<meta name="twitter:creator:id" content="@oubiwann">
<meta name="twitter:title" content="Async in Clojure: Playing with Agents, Part II">
<meta name="twitter:url" content="https://oubiwann.github.io/blog/archives/2012-10/30-132208/async-in-clojure-playing-with-agents-part-ii.html">
<meta name="twitter:description" content="<p><p><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-wGUH0hB0Yls/UI62EO3wsBI/AAAAAAAAALw/HiyFdql7fI Y/s1600/clojure-logo-large.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="200" src="http://2.bp.blogspot.com/-wGUH0hB0Yls/UI62EO3wsBI/AAAAAAAAALw/HiyFdql7fIY /s200/clojure-logo-large.png" width="200" /></a></div><br />In <a ...</p>">
<meta name="twitter:image" content="https://oubiwann.github.io/blog/img/ob-post-6.jpg">

    
    

    <link rel="alternate" type="application/atom+xml" title="Feed" href="/blog/atom.xml" />
    

    <!-- Webfonts Setup /-->
    <link href="https://fonts.googleapis.com/css?family=Maitree&amp;subset=latin-ext"
          rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Yantramanav&amp;subset=latin-ext"
          rel="stylesheet" type="text/css">

    <!-- Bootstrap/Custom Styles Setup /-->
    <link rel="stylesheet" href="/blog/assets/highlightjs/styles/arta.css" type="text/css">
    <link rel="stylesheet" href="/blog/assets/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/blog/assets/bootswatch/css/custom.min.css" rel="stylesheet" type="text/css" id="theme">
    <link rel="stylesheet" href="/blog/css/theme.css" rel="stylesheet" type="text/css" id="theme" media="screen">

    <!-- Favicon Setup /-->
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/icons/apple-touch-icon.png?v=3">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/icons/favicon-32x32.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="/blog/icons/favicon-16x16.png?v=3">
    <link rel="manifest" href="/blog/icons/manifest.json?v=3">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg?v=3" color="#5bbad5">
    <link rel="shortcut icon" href="/blog/icons/favicon.ico?v=3">
    <meta name="apple-mobile-web-app-title" content="FRMX">
    <meta name="application-name" content="o|b">
    <meta name="msapplication-config" content="/blog/icons/browserconfig.xml?v=3">
    <meta name="theme-color" content="#ffffff">
    
    
    
    
    
  

  </head>
  
  <body>
  
   
    <header class="tiny">
      
<div class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
  <div class="container">
    <div class="navbar-brand-wrapper">
      <a href="/blog/" class="navbar-brand">o|b</a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

   <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/blog/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/archives">Archives</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/categories">Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/tags">Tags</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/authors">Authors</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="about">About <span class="caret"></span></a>
          <div class="dropdown-menu" aria-labelledby="about">
            <a class="dropdown-item" href="/blog/about/">The Blog</a>
            <a class="dropdown-item" href="/blog/about/contact/">Contact Us</a>
            <a class="dropdown-item" href="/blog/about/powered-by/">Powered By</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/blog/about/license/">License</a>
          </div>
        </li>
      </ul>

      <ul class="nav navbar-nav ml-auto social-nav">
        <li class="nav-item">
          <a href="/blog/atom.xml" alt="Atom Feed">
            <i class="fa fa-feed first"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://twitter.com/oubiwann" alt="Twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="/googleplus" alt="Google+">
            <i class="fa fa-google-plus"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="http://github.com/oubiwann" alt="Github">
            <i class="fa fa-github"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://groups.google.com/forum/#!forum/oubiwann-blog-new-posts"
             alt="Email Notifications">
            <i class="fa fa-envelope"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

    </header>
    
    
    <main id="main-content">
      

    <!-- Page Content -->
    <div class="container page-content">

      <div class="row">

        <!-- Post Content Column -->
        <div class="col-lg-12">

          <!-- Title -->
          <h1 class="mt-4">Async in Clojure: Playing with Agents, Part II</h1>

          <!-- Author -->
          <p class="lead">
            Posted on October 30,
            2012 by
            <a href="/blog/authors#oubiwann">oubiwann</a>
          </p>

          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link show active" data-toggle="tab" href="#content">Content</a>
            </li>
            <li class="nav-item">
              <a class="nav-link show" data-toggle="tab" href="#metadata">Metadata</a>
            </li>
          </ul>

          <br/>

          <div id="post-content" class="tab-content">
            <div class="tab-pane fade active show" id="content">

          <!-- Post Image -->
          <img class="card-img-top" src="/blog/img/ob-post-6.jpg" alt="Blog post image">

          <hr>

          <!-- Post Content -->
          <p><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-wGUH0hB0Yls/UI62EO3wsBI/AAAAAAAAALw/HiyFdql7fI Y/s1600/clojure-logo-large.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="200" src="http://2.bp.blogspot.com/-wGUH0hB0Yls/UI62EO3wsBI/AAAAAAAAALw/HiyFdql7fIY /s200/clojure-logo-large.png" width="200" /></a></div><br />In <a href="http://blog.mindpool.io/2012/10/async-in-clojure-playing-with-agents.htm l">the last post</a>, we took a look at basic usage of <a href="http://clojure.org/">Clojure</a>'s <span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">agent</span></span> function. In this post, we'll dive a little bit deeper<br /><br /><b>Validation</b><br />We glossed over the options that you can define when creating an agent; one of them is the <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">validator</span></span> which one can use to check before the agent is updated with the passed value.<br /><br />If we want to make sure that our <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">read-agent</span></span> always gets a string value, this is all we have to do:<br /><br /><script src="https://gist.github.com/3977479.js?file=01-validation.clj"></script> <br />Similarly, any function that takes a single value as a parameter can be used here. As you can see, we had to change our default value for the agent from <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">nil</span></span> to <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">""</span></span> since there is now a string validator. If we hadn't, any time we tried to use that agent, we'd get <span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">java.lang.IllegalStateException</span></span>.<br /><br /><b>When Things Go Wrong</b><br />Another option you can set when defining an agent is the error handler. This will be used in the event of an error, including if a value fails to be validated by your validator function. Here's an example:<br /><br /><script src="https://gist.github.com/3977479.js?file=02-error-handler.clj"></script> < br />With both of these options, you don't have to set them when the agent is defined; you can do it later with a function call, if you so desire (or if needs demand it):<br /><br /><script src="https://gist.github.com/3977479.js?file=03-set-options.clj"></script> <br /><b>Watch This!</b><br />So, we've got an error handler but no event handler? Yup. However, you <i>can</i> actually get callback-like behavior using <span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">watch</span></span>es. Check this out:<br /><br /><script src="https://gist.github.com/3977479.js?file=04-callbacks.clj"></scr ipt> <br />Now, any time our agent's state changes, the function passed to the watch will fire. As described in <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/add -watch">the docs</a>, the parameters are: the agent, a key of your devising (must be unique per agent), and the handler that you want to have fired upon state change. The handler takes as parameters: the key you defined, the agent, the agent's old value, and the agent's new value.<br /><br /><b>All Together Now</b><br />With all our example code in place, we can now exercise the whole thing at once. Here's the whole thing:<br /><br /><script src="https://gist.github.com/3977479.js?file=05-agent.clj"></script> <br />To simply demonstrate the async nature and the callbacks in action, let's run the following:<br /><br /><script src="https://gist.github.com/3977479.js?file=06-repl.txt"></script> <br />Eventually, our callback will render output very much like the following:<br /><br /><script src="https://gist.github.com/3977479.js?file=07-repl.txt"></script> <br />Do note, however, that if we called a series of <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">send-off</span></span>s with different times (using the same agent and watch), we wouldn't see the ones with shorter times come back first. We'd see the callback output in the same order we called <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">send-off</span></span>. This is because the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">watch</span></span> function is called synchronously on the agent's thread before any pending <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">send-off</span></span>s (or <span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">send</span></span>s) are called. In future posts, I'll cover ways around this (constructing agents on the fly as well as exploring alternative solutions with external libraries).<br /><br />Regardless, with these primitives, there are all sorts of things one can do. For instance...<br /><br /><b>Dessert</b><br />To close, check out this neat little bit of code that sends 1,000,000 messages in a ring. This code creates a chain of agents, and then actions are relayed through it (taken from the <a href="http://clojure.org/agents">agents doc page</a>): <br /><br /><script src="https://gist.github.com/3977479.js?file=08-relay-ring.clj"></script> <br />Kicking this puppy off, our million messages finish in about 1 second :-)<br /><br /><br /><script src="https://gist.github.com/3977479.js?file=09-repl.txt"></script> </p>

            </div>
            <div class="tab-pane fade" id="metadata">

              <table class="table table-hover">
                <tbody>
                  <tr class="table-secondary">
                    <th scope="row">Author</th>
                    <td>oubiwann</td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Date</th>
                    <td>October 30,
        2012</td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Time</th>
                    <td>13:22:08</td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Category</th>
                    <td>
                        <a href="/blog/categories/#"></a>
                    </td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Tags</th>
                    <td>
                      
                      <a href="/blog/tags/#actors">actors</a>
                      
                      <a href="/blog/tags/#agents">agents</a>
                      
                      <a href="/blog/tags/#async">async</a>
                      
                      <a href="/blog/tags/#clojure">clojure</a>
                      
                      <a href="/blog/tags/#errors">errors</a>
                      
                      <a href="/blog/tags/#lisp">lisp</a>
                      
                      <a href="/blog/tags/#reblog">reblog</a>
                      
                      <a href="/blog/tags/#threadpools">threadpools</a>
                      
                      <a href="/blog/tags/#threads">threads</a>
                      
                      <a href="/blog/tags/#validators">validators</a>
                      
                    </td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Line&nbsp;Count</th>
                    <td>1 </td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Word&nbsp;Count</th>
                    <td>638 </td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Character&nbsp;Count</th>
                    <td>5931 </td>
                  </tr>
                </tbody>
              </table>

            </div>
          </div>

          <hr>

          <!-- Comments Note -->
          <div class="card my-4">
            <h5 class="card-header">Comments?</h5>
            <div class="card-body">
              This blog doesn't use standard (embedded) comments; however, since
              the site is hosted on Github, if there <emphasis>is</emphasis>
              something you'd like to share, please do so by
              <a href="https://github.com/oubiwann/blog/issues/new">opening a
              "comment" ticket!</a>
            </div>
          </div>

        </div>

      </div>
      <!-- /.row -->

    </div>
    <!-- /.container -->

<!-- End main page content -->

    </main>
    
    
    <footer id="footer">
      
        <div class="row">
          <div class="col-lg-6">

            <ul class="list-unstyled">
              <li class="text-muted">Blogs</li>
              <li><a href="http://oubiwann.blogspot.com">Electric Duncan</a></li>
              <li><a href="http://blog.lfe.io/">LFE Blog</a></li>
              <li><a href="http://clojang.lfe.io/">Clojang</a></li>
              <li><a href="https://clozhang.github.io/blog/">Clozhang</a></li>
            </ul>

          </div>
          <div class="col-lg-6">
            <ul class="list-unstyled">
              <li class="float-lg-right text-muted">Github orgs</li>
              <li class="float-lg-right"><a href="https://github.com/erlsci">erlsci</a></li>
              <li class="float-lg-right"><a href="https://github.com/lfex">lfex</a></li>
              <li class="float-lg-right"><a href="https://github.com/clozhang">clozhang</a></li>
              <li class="float-lg-right"><a href="https://github.com/clojang">clojang</a></li>
              <li class="float-lg-right"><a href="https://github.com/clojusc">clojusc</a></li>
              <li class="float-lg-right"><a href="https://github.com/hexagram30">hexagram30</a></li>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-6">
          </div>
          <div class="col-lg-6">
            <ul class="list-unstyled">

              <li class="float-lg-right"><a href="https://github.com/masteringmatplotlib">masteringmatplotlib</a></li>
              <li class="float-lg-right"><a href="https://github.com/usgs-lcmap">usgs-lcmap</a></li>
              <li class="float-lg-right"><a href="https://github.com/nasa-ngap-archives">nasa-ngap-archives</a></li>
              <li class="float-lg-right"><a href="https://github.com/nasa-cmr-archives">nasa-cmr-archives</a></li>

            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-12">
            <p><a href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png">
            </a></p>
            <p class="text-muted">Content released under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License.</a>.</p>
            <p class="text-muted">Copyright &copy; Duncan McGreggor, 2003-2019</p>
          </div>
        </div>


    </footer>
    
    
    <script src="/blog/assets/jquery/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/popper.js/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/bootstrap/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/bootswatch/js/custom.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/highlightjs/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
  
  </body>
</html>
