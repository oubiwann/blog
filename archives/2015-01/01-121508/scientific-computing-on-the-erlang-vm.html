<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en" class="no-js"> <!--<![endif]-->
  
  
  
  <head profile="http://dublincore.org/documents/dcq-html/">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1179318-5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-1179318-5');
    </script>
    <meta charset="utf-8">
    <title>
    
      oubiwann | blog
      
      
      
    
    </title>
    

    
    
    
    <!-- General Metadata (site-wide) -->
    <meta name="description" content="A 21st century .plan for Duncan McGreggor">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="oubiwann | blog: version 5.0.0-SNAPSHOT, build f72b49e

">

    <!-- Google Metadata -->
    <meta name="google-site-verification" content="w0pQqmlRRJk36_i3se1w2U7qwG8kS_VqiLS2hq5Wk7g" />

    <!-- Dublic Core Metadata (site-wide) -->
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
    <link rel="schema.DCTERMS" href="http://purl.org/dc/terms/">
    <meta name="DC.format" scheme="DCTERMS.IMT" content="text/html">
    <meta name="DC.type" scheme="DCTERMS.DCMIType" content="Text">
    <meta name="DC.coverage" content="2003-2019">
    <meta name="DC.rights" content="Creative Commons Attribution-ShareAlike 4.0 International License">
    <meta name="DC.publisher" content="C&amp;B|Books">
    <meta name="DCTERMS.audience" content="Developers, Software Engineers, Computer Scientists, Technologists, Programmers, Programming Language Enthusiasts, Operational Engineers">

    
    
<!-- General Metadata (per-page) -->
<meta name="author" content="">

<!-- Dublic Core Metadata (per-page) -->
<meta name="DC.title" lang="en" content="Scientific Computing on the Erlang VM">
<meta name="DC.creator" content="oubiwann">
<meta name="DC.subject" content="LFE">
<meta name="DC.date" content="2015-01-01">
<meta name="DC.identifier" scheme="DCTERMS.URI" content="https://oubiwann.github.io/blog/archives/2015-01/01-121508/scientific-computing-on-the-erlang-vm.html">
<meta name="DCTERMS.abstract" content="Polynomial Curve Fitting with LFE">

<!-- Facebook's OpenGraph Metadata -->
<meta property="og:site_name" content="o|b">
<meta property="og:title" content="Scientific Computing on the Erlang VM">
<meta property="og:url" content="https://oubiwann.github.io/blog/archives/2015-01/01-121508/scientific-computing-on-the-erlang-vm.html">
<meta property="og:type" content="blog">
<meta property="og:description" content="Polynomial Curve Fitting with LFE">
<meta property="og:image" content="https://oubiwann.github.io/blog/img/lsci-erlang-ecosystem.jpg">
<meta property="article:author" content="">
<meta property="article:published_time" content="2015-01-01 12:15:08">
<meta property="article:modified_time" content="">
<meta property="og:updated_time" content="">
<meta property="article:section" content="LFE">


<!-- Twitter Card Metadata -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site:id" content="@oubiwann">
<meta name="twitter:creator:id" content="@ErlangLisp">
<meta name="twitter:title" content="Scientific Computing on the Erlang VM">
<meta name="twitter:url" content="https://oubiwann.github.io/blog/archives/2015-01/01-121508/scientific-computing-on-the-erlang-vm.html">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://oubiwann.github.io/blog/img/lsci-erlang-ecosystem.jpg">

    
    

    <link rel="alternate" type="application/atom+xml" title="Feed" href="/blog/atom.xml" />
    

    <!-- Webfonts Setup /-->
    <link href="https://fonts.googleapis.com/css?family=Maitree&amp;subset=latin-ext"
          rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Yantramanav&amp;subset=latin-ext"
          rel="stylesheet" type="text/css">

    <!-- Bootstrap/Custom Styles Setup /-->
    <link rel="stylesheet" href="/blog/assets/highlightjs/styles/arta.css" type="text/css">
    <link rel="stylesheet" href="/blog/assets/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/blog/assets/bootswatch/css/custom.min.css" rel="stylesheet" type="text/css" id="theme">
    <link rel="stylesheet" href="/blog/css/theme.css" rel="stylesheet" type="text/css" id="theme" media="screen">

    <!-- Favicon Setup /-->
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/icons/apple-touch-icon.png?v=3">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/icons/favicon-32x32.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="/blog/icons/favicon-16x16.png?v=3">
    <link rel="manifest" href="/blog/icons/manifest.json?v=3">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg?v=3" color="#5bbad5">
    <link rel="shortcut icon" href="/blog/icons/favicon.ico?v=3">
    <meta name="apple-mobile-web-app-title" content="FRMX">
    <meta name="application-name" content="o|b">
    <meta name="msapplication-config" content="/blog/icons/browserconfig.xml?v=3">
    <meta name="theme-color" content="#ffffff">
    
    

    <!-- Scripts /-->
    
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
    });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
    
    
  

  </head>
  
  <body>
  
   
    <header class="tiny">
      
<div class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
  <div class="container">
    <div class="navbar-brand-wrapper">
      <a href="/blog/" class="navbar-brand">o|b</a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

   <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/blog/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/archives">Archives</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/categories">Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/tags">Tags</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog/authors">Authors</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="about">About <span class="caret"></span></a>
          <div class="dropdown-menu" aria-labelledby="about">
            <a class="dropdown-item" href="/blog/about/">The Blog</a>
            <a class="dropdown-item" href="/blog/about/contact/">Contact Us</a>
            <a class="dropdown-item" href="/blog/about/powered-by/">Powered By</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/blog/about/license/">License</a>
          </div>
        </li>
      </ul>

      <ul class="nav navbar-nav ml-auto social-nav">
        <li class="nav-item">
          <a href="/blog/atom.xml" alt="Atom Feed">
            <i class="fa fa-feed first"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://twitter.com/oubiwann" alt="Twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="/googleplus" alt="Google+">
            <i class="fa fa-google-plus"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="http://github.com/oubiwann" alt="Github">
            <i class="fa fa-github"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://groups.google.com/forum/#!forum/oubiwann-blog-new-posts"
             alt="Email Notifications">
            <i class="fa fa-envelope"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

    </header>
    
    
    <main id="main-content">
      

    <!-- Page Content -->
    <div class="container page-content">

      <div class="row">

        <!-- Post Content Column -->
        <div class="col-lg-12">

          <!-- Title -->
          <h1 class="mt-4">Scientific Computing on the Erlang VM</h1>

          <!-- Author -->
          <p class="lead">
            Posted on January 01,
            2015 by
            <a href="/blog/authors#oubiwann">oubiwann</a>
          </p>

          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link show active" data-toggle="tab" href="#content">Content</a>
            </li>
            <li class="nav-item">
              <a class="nav-link show" data-toggle="tab" href="#metadata">Metadata</a>
            </li>
          </ul>

          <br/>

          <div id="post-content" class="tab-content">
            <div class="tab-pane fade active show" id="content">

          <!-- Post Image -->
          <img class="card-img-top" src="/blog/img/lsci-erlang-ecosystem.jpg" alt="Blog post image">

          <hr>

          <!-- Post Content -->
          <p><a href="{{ site.base<i>url }}/assets/images/posts/lsci-erlang-ecosystem.png"><img class="right thumb" src="{{ site.base</i>url }}/assets/images/posts/lsci-erlang-ecosystem.png" /></a>This tutorial brings in the New Year by introducing the Erlang/LFE scientific computing library <a href='https://github.com/lfex/lsci'>lsci</a> &ndash; a ports wrapper of NumPy and SciPy (among others) for the Erlang ecosystem. The topic of the tutorial is polynomial curve-fitting for a given data set. Additionally, this post further demonstrates <a href='https://github.com/lfex/py/'>py</a> usage, the <a href='http://localhost:4000/announcements/2014/12/27/1641-easy-python-from-lfeerlang'>previously discussed</a> Erlang/LFE library for running Python code from the Erlang VM.</p><h2>Background</h2><p>The content of this post was taken from a <a href='http://technicae.cogitat.io/2014/11/scientific-computing-with-hy.html'>similar tutorial</a> done by the same author for the Python Lisp <a href='http://hylang.org/'>Hy</a> in an <a href='http://nbviewer.ipython.org/github/oubiwann/linear-regression-tutorial/blob/master/notebooks/tutorial.ipynb'>IPython notebook</a>. It, in turn, was completely inspired by the <a href='http://data-sorcery.org/2009/06/04/linear-regression-with-higher-order-terms/'>Clojure Incanter tutorial</a> on the same subject, by David Edgar Liebke.</p><p>This content is also available in the <a href='https://github.com/lfex/lsci/tree/cbba7e4705bdc8baaa8b8abaf40ae1649ed44b42/examples/polyfit'>lsci examples directory</a>.</p><h2>Introduction</h2><p>The lsci library (pronounced "Elsie") provides access to the fast numerical processing libraries that have become so popular in the scientific computing community. lsci is written in LFE but can be used just as easily from Erlang.</p><p>lsci provides the following set of features:</p><ul><li>Wrapper functions (many generated dynamically via macros) for:<ul><li>The Python 3 standard library module <a href='https://docs.python.org/3/library/math.html'>math</a></li><li>The Python 3 standard library module <a href='https://docs.python.org/3/library/cmath.html'>cmath</a></li><li>The Python 3 standard library module <a href='https://docs.python.org/3/library/statistics.html'>statistics</a></li><li><a href='http://www.numpy.org/'>NumPy</a></li><li><a href='http://www.scipy.org/scipylib/index.html'>SciPy</a></li><li>Planned support for     <a href='https://docs.python.org/3/library/fractions.html'>fractions</a>,     <a href='https://docs.python.org/3/library/decimal.html'>decimal</a>,     <a href='http://pandas.pydata.org/'>Pandas</a>,     <a href='http://matplotlib.org/'>matplotlib</a>, and     <a href='http://www.sympy.org/en/index.html'>SymPy</a></li></ul></li><li>The <a href='https://github.com/lfex/py/'>py</a> wrappers for   <a href='http://erlport.org/'>ErlPort</a> which make calling Python   module-level functions, object attributes and methods, constructors,   function objects, etc., very easy</li><li>Custom encoders/decoders for some of the wrapped data types</li></ul></li></ul><p>lsci is brand-new, and thus has far to go before it completely wraps all the functionality in NumPy, SciPy, etc. However, enough of it is done that one can perform tasks like polynomial curve-fitting and statistical regression.</p><h2>Setup</h2><p>To run this tutorial, you will need the following on your system:</p><ul><li>Erlang (tested with 17.3)<ul><li>rebar</li><li>lfetool</li><li>Python 3</li><li>git</li></ul></li></ul><p>With those in place, let's get you ready:</p><pre><code class="cl">$ git clone git@github.com:lfex/lsci.git
$ cd lsci
$ make
$ . ./python/.venv/bin/activate
</code></pre><p>That will download all the Erlang and Python dependencies, compile the Erlang libs, and set up a Python virtualenv in your working directory. If you are not familiar with Python, the last command is what allows one to actually use the Python virtualenv, with all the libraries you just downloaded.</p><p>You are now ready for the LFE REPL:</p><pre><code class="cl">$ make repl-no-deps
</code></pre><h2>Loading Data</h2><p>The "observed data" we're going to use is the same data set as that used in the <a href='http://data-sorcery.org/2009/06/04/linear-regression-with-higher-order-terms/'>Incanter linear regression tutorial</a>, the <a href='http://www.itl.nist.gov/div898/strd/lls/data/LINKS/DATA/Filip.dat'>NIST Filip.dat</a> file. The data file we will use is a conversion of the original NIST file to CSV.</p><p>Let's load our experimental data:</p><pre><code class="cl">&gt; &#40;set data &#40;lsci-np:genfromtxt
              &quot;examples/polyfit/filip.csv&quot;
              `&#40;#&#40;delimiter ,&#40;list&#95;to&#95;binary &quot;,&quot;&#41;&#41;
                #&#40;names true&#41;&#41;&#41;&#41;
#&#40;$erlport.opaque python
  #B&#40;128 2 99 110 117 109 112 121 46 99 111 114 101 46 109 117 108 ...&#41;&#41;
</code></pre><p>The data returned by this function is an ErlPort binary wrapping a Python pickle of a NumPy array. We can take a look at the data by converting it to a list:</p><pre><code class="cl">&gt; &#40;lsci-np:-&gt;list data&#41;
&#40;#&#40;0.8116 -6.860120914&#41;
 #&#40;0.9072 -4.324130045&#41;
 #&#40;0.9052 -4.358625055&#41;
 #&#40;0.9039 -4.358426747&#41;
 #&#40;0.8053 -6.955852379&#41;
 #&#40;0.8377 -6.661145254&#41;
 #&#40;0.8667 -6.355462942&#41;
 #&#40;0.8809 -6.118102026&#41;
 #&#40;0.7975 -7.115148017&#41;
 #&#40;0.8162 -6.815308569&#41;
 #&#40;0.8515 -6.519993057&#41;
 #&#40;0.8766 -6.204119983&#41;
 #&#40;0.8885 -5.853871964&#41;
 #&#40;0.8859 -6.109523091&#41;
 #&#40;0.8959 -5.79832982&#41;
 #&#40;0.8913 -5.482672118&#41;
 #&#40;0.8959 -5.171791386&#41;
 #&#40;0.8971 -4.851705903&#41;
 #&#40;0.9021 -4.517126416&#41;
 #&#40;0.909 -4.143573228&#41;
 #&#40;0.9139 -3.709075441&#41;
 #&#40;0.9199 -3.499489089&#41;
 #&#40;0.8692 -6.300769497&#41;
 #&#40;0.8872 -5.953504836&#41;
 #&#40;0.89 -5.642065153&#41;
 #&#40;0.891 -5.031376979&#41;
 #&#40;0.8977 -4.680685696&#41;
 #&#40;0.9035 -4.329846955&#41;
 #&#40;0.9078 ...&#41;
 #&#40;...&#41; ...&#41;
</code></pre><h2>A Note about Values</h2><p>If you haven't noticed yet, you certainly will as you run through these examples in the LFE REPL: we keep getting opaque binary data back from NumPy. Why can't lsci just convert that?</p><p>While it would be nice to have that data presented to us in the REPL in such a way that we could <em>actually tell</em> what is was, this would run counter to the whole purpose of using libraries like NumPy and SciPy from the Erlang VM in the first place. It would do several things:</p><ul><li>Add latency for each calculation</li><li>Reduce the precision available in the NumPy data types (by being converted  first to Python native types and then to Erlang data types)</li><li>Bring only Erlang-native data types into the REPL, thus requiring us to  create new NumPy data types to pass <em>back</em> to Python if we wanted to benefit  from NumPy's speed, or another way of saying this,</li><li>Make it difficult to pass results back into NumPy for further processing</li></ul><p>As such, lsci compromises by providing convenience functions for converting returned results to something we can look at. We will use such functions as ``->list`` and ``->float`` in the remainder of this tutorial for just that purpose.</p><h2>Plotting Our Data</h2><p>Because our CSV file had headers and we told ``genfromtxt`` to use them with the ``#(names true)`` option, we can easily extract the $x$ and $y$ axis data. Let's look at their values separately:</p><pre><code class="cl">&gt; &#40;set xs &#40;lsci-np:get data 'x&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ys &#40;lsci-np:get data 'y&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;lsci-np:-&gt;list xs&#41;
&#40;-6.860120914 -4.324130045 -4.358625055 -4.358426747 -6.955852379
 -6.661145254 -6.355462942 -6.118102026 -7.115148017 -6.815308569
 -6.519993057 -6.204119983 -5.853871964 -6.109523091 -5.79832982
 -5.482672118 -5.171791386 -4.851705903 -4.517126416 -4.143573228
 -3.709075441 -3.499489089 -6.300769497 -5.953504836 -5.642065153
 -5.031376979 -4.680685696 -4.329846955 -3.928486195 -8.56735134 ...&#41;
&gt; &#40;lsci-np:-&gt;list ys&#41;
&#40;0.8116 0.9072 0.9052 0.9039 0.8053 0.8377 0.8667 0.8809 0.7975
 0.8162 0.8515 0.8766 0.8885 0.8859 0.8959 0.8913 0.8959 0.8971
 0.9021 0.909 0.9139 0.9199 0.8692 0.8872 0.89 0.891 0.8977 0.9035
 0.9078 0.7675 ...&#41;
</code></pre><p>Now let's plot our data in the terminal:</p><pre><code class="cl">&gt; &#40;lsci-asciiplot:scatter xs ys&#41;
</code></pre><p>Which will give you something like this:</p><pre><code>                                                                           oo  o o
                                                                      o o
                                                                  o  o   o
                                                               oo
                                                        o o o
                                          o      o o  o o  o
                                        ooo ooo      o
                                     oo o
                                    oooo
                                    oo
                                 ooo
                                  o
                                 o
                               o
                               oo

                             o
                              o
                             o

                           o
                          o o
                         o o

                       oo o
                       o
                     o
                   oo
o           o  ooo
     oooo oo
o oo
o

ok
</code></pre><h2>Curve Fitting</h2><p>The <a href='http://www.itl.nist.gov/div898/strd/lls/data/LINKS/DATA/Filip.dat'>NIST data set</a> provided a polynomial describing this data:</p><pre><code>y = B0 + B1&#42;x + B2&#42;&#40;x&#42;&#42;2&#41; + ... + B9&#42;&#40;x&#42;&#42;9&#41; + B10&#42;&#40;x&#42;&#42;10&#41; + e
</code></pre><p>Or, if you prefer LaTeX:</p><p>$$\begin{equation}y = B_0 + B_1{x} + B_2{x^2} + ... + B_9{x^9} + B_{10}{x^{10}} + e\end{equation}$$</p><p>Using NumPy, we can easily fit a 10th-degree polynomial curve to this data. We will use ``numpy.polyfit`` for finding a least squares polynomial fit, passing it the $x$ and $y$ values for the data to fit as well as the degree of our polynomial:</p><pre><code class="cl">&gt; &#40;set coeffs &#40;lsci-np:polyfit xs ys 10&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
</code></pre><p>Let's peek at the data:</p><pre><code class="cl">&gt; &#40;lsci-np:-&gt;list coeffs&#41;
&#40;-4.029625205186532e-5 -0.0024678107546401437 -0.06701911469215643
 -1.0622149736864719 -10.875317910262362 -75.12420087227511
 -354.47822960532113 -1127.973927925715 -2316.371054759451
 -2772.1795597594755 -1467.4895971641686&#41;
</code></pre><p>``numpy.polyfit`` can return more data, if you are so inclined, by passing the ``#(full true)`` option:</p><pre><code class="cl">&gt; &#40;set `#&#40;,coeffs
          ,residuals
          ,rank
          ,singular-values
          ,rcond&#41; &#40;lsci-np:polyfit xs ys 10 '&#40;#&#40;full true&#41;&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;lsci-np:-&gt;list coeffs&#41;
&#40;-4.029625205186532e-5 -0.0024678107546401437 -0.06701911469215643
 -1.0622149736864719 -10.875317910262362 -75.12420087227511
 -354.47822960532113 -1127.973927925715 -2316.371054759451
 -2772.1795597594755 -1467.4895971641686&#41;
&gt; &#40;lsci-np:-&gt;list residuals&#41;
&#40;7.958513839371895e-4&#41;
&gt; rank
11
&gt; &#40;lsci-np:-&gt;list singular-values&#41;
&#40;3.128894711145785 1.064548669029962 0.27180324022363517
 0.05296821542551952 0.008387108325776571 0.0010157565988992792
 9.583030547029836e-5 7.605115790256685e-6 4.6491044714423815e-7
 1.9871421381342612e-8 6.009222284310632e-10&#41;
&gt; &#40;lsci-np:-&gt;list rcond&#41;
1.8207657603852567e-14
</code></pre><p>There is a convenience class in NumPy ``numpy.poly1d`` that, once instantiated with our fit data, we can use to evaluate at any given point. Let's try it out:</p><pre><code class="cl">&gt; &#40;set model &#40;lsci-np:poly1d coeffs&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
</code></pre><p>Let's call this function against several values as a sanity check:</p><pre><code class="cl">&gt; &#40;lsci-np:-&gt;list &#40;py:func model '&#40;-9&#41;&#41;&#41;
0.7766886098502255
&gt; &#40;lsci-np:-&gt;list &#40;py:func model '&#40;-7&#41;&#41;&#41;
0.7990591787051926
&gt; &#40;lsci-np:-&gt;list &#40;py:func model '&#40;-6&#41;&#41;&#41;
0.8860483219018533
&gt; &#40;lsci-np:-&gt;list &#40;py:func model '&#40;-5&#41;&#41;&#41;
0.8926343904781788
&gt; &#40;lsci-np:-&gt;list &#40;py:func model '&#40;-4&#41;&#41;&#41;
0.9094348679923314
&gt; &#40;lsci-np:-&gt;list &#40;py:func model '&#40;-3&#41;&#41;&#41;
0.8893022773313533
</code></pre><p>By examining our original data set, we can see that these check out just fine.</p><h2>Polynomial Linear Regression</h2><p>Next let's see if our linear model matches up with what NIST provided. We're going to need to calculate the <a href='http://en.wikipedia.org/wiki/Coefficient_of_determination'>coefficient of determination</a>, or $R^2$ &ndash; a value that indicates how well a statistical model fits with measured data. We'll start by feeding our $x$ values into our model:</p><pre><code class="cl">&gt; &#40;set y-predicted &#40;py:func model `&#40;,xs&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;lsci-np:-&gt;list y-predicted&#41;
&#40;0.8115567059126079 0.9058214190752096 0.9051532611576931
 0.9051572417567968 0.8027951904375641 0.8316306323870322
 0.8619032382121077 0.8798465345066688 0.7904039687107343
 0.8159121506946576 0.8461646108687546 0.8741409704916805
 0.8911095569417284 0.880361461470784 0.8923272580695993
 0.8938414797164569 0.8922115816051246 0.8943421465901338
 0.9015888194142008 0.908406582014095 0.9117908062162314
 0.9177642755723809 0.8666215053945052 0.8879651108427424
 0.8940117353472488 0.8924367760930636 0.897684962889798
 0.9057141589178173 0.9097792825882607 0.7667388250863496 ...&#41;
</code></pre><p>We will also need several other values in order to calculate $R^2$, per the equation given on the Wikipedia page linked above:</p><ul><li>The mean value of our observed (original) data:  $\bar{y}=\frac{1}{n}\sum_{i=1}^n y_i$</li><li>The total sum of squares : $SS_\text{tot}=\sum_i (y_i-\bar{y})^2$</li><li>The regression sum of squares : $SS_\text{reg}=\sum_i (f_i -\bar{y})^2$</li><li>The sum of squares of residuals : $SS_\text{res}=\sum_i (y_i - f_i)^2$</li></ul><p>We already have the following:</p><ul><li>$y_i$: the $y$ values from the observed (NIST) data</li><li>$f_i$: the values generated by our model</li></ul><p>With these, we will be able to calculate $R^2$:</p><p>$$\begin{equation}R^2 \equiv 1 - {SS_{\rm res}\over SS_{\rm tot}}\end{equation}$$</p><p>Here are the calculations:</p><pre><code class="cl">&gt; &#40;set y-mean &#40;lsci-np:/ &#40;lsci-np:sum ys&#41; &#40;lsci-np:size ys&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ss-tot &#40;lsci-np:sum &#40;lsci-np:&#94; &#40;lsci-np:- ys y-mean&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ss-reg &#40;lsci-np:sum &#40;lsci-np:&#94; &#40;lsci-np:- y-predicted y-mean&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ss-res &#40;lsci-np:sum &#40;lsci-np:&#94; &#40;lsci-np:- ys y-predicted&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
</code></pre><p>Instead of ``(lsci-np:^ ...)`` you may use ``(lsci-np:** ...)``, if you prefer, e.g.:</p><pre><code class="cl">&gt; &#40;set ss-res &#40;lsci-np:sum &#40;lsci-np:&#42;&#42; &#40;lsci-np:- ys y-predicted&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
</code></pre><p>Those use shortened aliases; you may prefer the long form:</p><pre><code class="cl">&gt; &#40;set y-mean &#40;lsci-np:divide &#40;lsci-np:sum ys&#41; &#40;lsci-np:size ys&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ss-tot &#40;lsci-np:sum &#40;lsci-np:power &#40;lsci-np:subtract ys y-mean&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ss-reg &#40;lsci-np:sum &#40;lsci-np:power &#40;lsci-np:subtract y-predicted y-mean&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ss-res &#40;lsci-np:sum &#40;lsci-np:power &#40;lsci-np:subtract ys y-predicted&#41; 2&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
</code></pre><p>Let's sanity-check the results:</p><pre><code class="cl">&gt; &#40;lsci-np:-&gt;float y-mean&#41;
0.8495756097560976
&gt; &#40;lsci-np:-&gt;float ss-tot&#41;
0.2431874712195122
&gt; &#40;lsci-np:-&gt;float ss-reg&#41;
0.24239162093851477
&gt; &#40;lsci-np:-&gt;float ss-res&#41;
7.958513853880548e-4
</code></pre><p>Now we're ready to get the $R^2$ value for our model:</p><pre><code class="cl">&gt; &#40;set r-squared &#40;lsci-np:- 1 &#40;lsci-np:/ ss-res ss-tot&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;lsci-np:-&gt;float r-squared&#41;
0.9967274161723995
</code></pre><p>If we compare this to the value from the original NIST data file, ``0.996727416185620 ``, we see that our model did pretty well:</p><pre><code class="cl">&gt; &#40;lsci-np:-&gt;float &#40;lsci-np:- r-squared 0.996727416185620&#41;&#41;
-1.3220535777236364e-11
</code></pre><p>That's a pretty tiny difference!</p><h2>A Linear Model Class</h2><p>The linear model code above is a bit cumbersome; it would be much more convenient for multiple-use if there was a Python class that did all the arithmetic for us, and we could just get attribute values ... So that's what we created:</p><pre><code class="python">class PolynomialLinearModel:
    &quot;A convenience class for creating polynomial linear models.&quot;
    def &#95;&#95;init&#95;&#95;&#40;self, xs, ys, degree&#41;:
        &#40;self.xs, self.ys&#41; = &#40;xs, ys&#41;
        self.degree = degree
        self.y&#95;mean = self.get&#95;y&#95;mean&#40;&#41;
        &#40;self.results, self.model, self.ys&#95;predicted,
         self.ss&#95;tot, self.ss&#95;reg, self.ss&#95;res,
         self.r&#95;squared&#41; = &#40;None, None, None, None, None, None, None&#41;
        &#40;self.coeffs, self.residuals, self.rank,
         self.singular&#95;values, self.rcond&#41; = &#40;None, None, None, None, None&#41;
        self.polyfit&#40;&#41;

    def polyfit&#40;self&#41;:
        &#40;self.coeffs, self.residuals, self.rank,
        self.singular&#95;values, self.rcond&#41; = np.polyfit&#40;
            self.xs, self.ys, self.degree, full=True&#41;
        self.model = np.poly1d&#40;self.coeffs&#41;
        self.ys&#95;predicted = self.model&#40;self.xs&#41;
        self.ss&#95;tot = self.get&#95;ss&#95;tot&#40;&#41;
        self.ss&#95;reg = self.get&#95;ss&#95;reg&#40;&#41;
        self.ss&#95;res = self.get&#95;ss&#95;res&#40;&#41;
        self.r&#95;squared = self.get&#95;r&#95;squared&#40;&#41;
        self.results = {
            &quot;coeffs&quot;: self.coeffs.tolist&#40;&#41;,
            &quot;residuals&quot;: self.residuals.tolist&#40;&#41;,
            &quot;rank&quot;: self.rank,
            &quot;singular-values&quot;: self.singular&#95;values.tolist&#40;&#41;,
            &quot;rcond&quot;: float&#40;self.rcond&#41;,
            &quot;y-mean&quot;: float&#40;self.y&#95;mean&#41;,
            &quot;ss-tot&quot;: float&#40;self.ss&#95;tot&#41;,
            &quot;ss-reg&quot;: float&#40;self.ss&#95;reg&#41;,
            &quot;ss-res&quot;: float&#40;self.ss&#95;res&#41;,
            &quot;r-squared&quot;: float&#40;self.r&#95;squared&#41;}

    def predict&#40;self, xs&#41;:
        return self.model&#40;xs&#41;

    def get&#95;y&#95;mean&#40;self&#41;:
        return self.ys.sum&#40;&#41; / self.ys.size

    def get&#95;ss&#95;tot&#40;self&#41;:
        return &#40;&#40;self.ys - self.get&#95;y&#95;mean&#40;&#41;&#41; &#42;&#42; 2&#41;.sum&#40;&#41;

    def get&#95;ss&#95;reg&#40;self&#41;:
        return &#40;&#40;self.ys&#95;predicted - self.get&#95;y&#95;mean&#40;&#41;&#41; &#42;&#42; 2&#41;.sum&#40;&#41;

    def get&#95;ss&#95;res&#40;self&#41;:
        return &#40;&#40;self.ys - self.ys&#95;predicted&#41; &#42;&#42; 2&#41;.sum&#40;&#41;

    def get&#95;r&#95;squared&#40;self&#41;:
        return 1 - self.get&#95;ss&#95;res&#40;&#41; / self.get&#95;ss&#95;tot&#40;&#41;

    def &#95;&#95;str&#95;&#95;&#40;self&#41;:
        return str&#40;self.results&#41;

    def &#95;&#95;repr&#95;&#95;&#40;self&#41;:
        return self.&#95;&#95;str&#95;&#95;&#40;&#41;
</code></pre><p>This has been saved to the Python module ``lsci.numpysupl`` with the ``lsci-np`` wrapper function ``lsci-np:poly-linear-model`` added. Now we can easily create a linear model which provides everything needed in one go:</p><pre><code class="cl">&gt; &#40;set model &#40;lsci-np:poly-linear-model xs ys 10&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;py:ptype model&#41;
lsci.numpysupl.PolynomialLinearModel
&gt; &#40;py:attr model 'results&#41;
#&#40;&quot;dict&quot;
  &#40;#&#40;&quot;rcond&quot; 1.8207657603852567e-14&#41;
   #&#40;&quot;rank&quot; 11&#41;
   #&#40;&quot;coeffs&quot;
     &#40;-4.029625205186532e-5 -0.0024678107546401437
      -0.06701911469215643 -1.0622149736864719 -10.875317910262362
      -75.12420087227511 -354.47822960532113 -1127.973927925715
      -2316.371054759451 -2772.1795597594755 -1467.4895971641686&#41;&#41;
   #&#40;&quot;residuals&quot; &#40;7.958513839371895e-4&#41;&#41;
   #&#40;&quot;ss-reg&quot; 0.24239162093851477&#41;
   #&#40;&quot;singular-values&quot;
     &#40;3.128894711145785 1.064548669029962 0.27180324022363517
      0.05296821542551952 0.008387108325776571 0.0010157565988992792
      9.583030547029836e-5 7.605115790256685e-6
      4.6491044714423815e-7 1.9871421381342612e-8
      6.009222284310632e-10&#41;&#41;
   #&#40;&quot;r-squared&quot; 0.9967274161723995&#41;
   #&#40;&quot;ss-res&quot; 7.958513853880548e-4&#41;
   #&#40;&quot;y-mean&quot; 0.8495756097560976&#41;
   #&#40;&quot;ss-tot&quot; 0.2431874712195122&#41;&#41;&#41;
</code></pre><p>We can also extract only what we need:</p><pre><code class="cl">&gt; &#40;set r-squared &#40;py:attr model 'r-squared&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;lsci-np:-&gt;float r-squared&#41;
0.9967274161723995
</code></pre><p>When we created our first model, we ran it against several values to see if the outputs fit our measured data. One of those was the value ``-9`` which returned ``0.77668860985022548``. Let's try that again with our new object:</p><pre><code class="cl">&gt; &#40;lsci-np:-&gt;float &#40;py:method model 'predict '&#40;-9&#41;&#41;&#41;
0.7766886098502255
</code></pre><p>Nice.</p><h2>Plotting the Model with the Observed Data</h2><p>We're going to need some data to feed to our fitted-poly function so that it can create the smooth polynomial curve that we will overlay on our scatter plot. Let's create a linear space between our minimum and maximum x values (200 points should give us a nice, smooth curve). Then let's use fitted-poly to generate the y values:</p><pre><code class="cl">&gt; &#40;set xs-fitted
    &#40;lsci-np:linspace
      &#40;py:method xs 'min&#41;
      &#40;py:method xs 'max&#41;
      `&#40;#&#40;num 200&#41;&#41;&#41;&#41;
#&#40;$erlport.opaque python ...&#41;
&gt; &#40;set ys-fitted
    &#40;py:method model 'predict `&#40;,xs-fitted&#41;&#41;&#41;
</code></pre><p>Now we're ready to put them together:</p><pre><code class="cl">&gt; &#40;defun plot-both &#40;&#41;
    &#40;lsci-asciiplot:scatter xs ys&#41;
    &#40;lsci-asciiplot:line
      xs-fitted ys-fitted
      '&#40;#&#40;hold true&#41;&#41;&#41;&#41;
plot-both
</code></pre><p>When we call our plot function:</p><pre><code class="cl">&gt; &#40;plot-both&#41;
</code></pre><p>We get the following, which shows the scatter plot of the original data (``o`` markers) with the polynomial curve fit overlaid (``-`` markers):</p><pre><code>                                                                           o-----o
                                                                      o o  --    -
                                                                  o  o ----
                                                               ---------
                                                        o o ----
                                          o      o o  o o---
                                        o----------------
                                     oo--
                                    o--o
                                    --
                                 oo--
                                  --
                                 o-
                               o -
                               o-
                               -
                             o -
                              -
                             -
                            --
                           o-
                          o-o
                         o--
                         --
                       o--o
                       --
                     o--
                   oo--
o           o  ooo --
     ooo------------
---------
o-

ok
</code></pre><h2>Conclusion</h2><p>And there you have it! Fast polynomial curve-fitting from LFE using Python, NumPy, and SciPy. The work has only just begun on lsci, so if this sort of thing floats your boat, be sure to take a look at <a href='https://github.com/lfex/lsci/issues'>some of the development tasks</a> and come give us a hand!</p><p>Even though there's a lot to do, there's a lot of reward :-) Every little function that gets converted brings enormous satisfaction: the ability to perform these sorts of computing tasks without having to leave the Erlang ecosystem is a wonderful change. We hope it's one that you not only get used to, but can't live without :-)</p>

            </div>
            <div class="tab-pane fade" id="metadata">

              <table class="table table-hover">
                <tbody>
                  <tr class="table-secondary">
                    <th scope="row">Author</th>
                    <td>oubiwann</td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Date</th>
                    <td>January 01,
        2015</td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Time</th>
                    <td>12:15:08</td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Category</th>
                    <td>
                        <a href="/blog/categories/#LFE">LFE</a>
                    </td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Tags</th>
                    <td>
                      
                      <a href="/blog/tags/#ascii">ascii</a>
                      
                      <a href="/blog/tags/#curve fitting">curve fitting</a>
                      
                      <a href="/blog/tags/#erlang">erlang</a>
                      
                      <a href="/blog/tags/#erlport">erlport</a>
                      
                      <a href="/blog/tags/#howtos">howtos</a>
                      
                      <a href="/blog/tags/#libraries">libraries</a>
                      
                      <a href="/blog/tags/#linear regression">linear regression</a>
                      
                      <a href="/blog/tags/#maths">maths</a>
                      
                      <a href="/blog/tags/#numpy">numpy</a>
                      
                      <a href="/blog/tags/#plotting">plotting</a>
                      
                      <a href="/blog/tags/#polynomials">polynomials</a>
                      
                      <a href="/blog/tags/#py">py</a>
                      
                      <a href="/blog/tags/#python">python</a>
                      
                      <a href="/blog/tags/#science">science</a>
                      
                      <a href="/blog/tags/#scientific computing">scientific computing</a>
                      
                      <a href="/blog/tags/#scipy">scipy</a>
                      
                      <a href="/blog/tags/#statistical analysis">statistical analysis</a>
                      
                      <a href="/blog/tags/#statistics">statistics</a>
                      
                      <a href="/blog/tags/#tutorials">tutorials</a>
                      
                    </td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Line&nbsp;Count</th>
                    <td>307 </td>
                  </tr>
                  <tr class="table-secondary">
                    <th scope="row">Word&nbsp;Count</th>
                    <td>2275 </td>
                  </tr>
                  <tr class="table-light">
                    <th scope="row">Character&nbsp;Count</th>
                    <td>25743 </td>
                  </tr>
                </tbody>
              </table>

            </div>
          </div>

          <hr>

          <!-- Comments Note -->
          <div class="card my-4">
            <h5 class="card-header">Comments?</h5>
            <div class="card-body">
              This blog doesn't use standard (embedded) comments; however, since
              the site is hosted on Github, if there <emphasis>is</emphasis>
              something you'd like to share, please do so by
              <a href="https://github.com/oubiwann/blog/issues/new">opening a
              "comment" ticket!</a>
            </div>
          </div>

        </div>

      </div>
      <!-- /.row -->

    </div>
    <!-- /.container -->

<!-- End main page content -->

    </main>
    
    
    <footer id="footer">
      
        <div class="row">
          <div class="col-lg-6">

            <ul class="list-unstyled">
              <li class="text-muted">Blogs</li>
              <li><a href="http://oubiwann.blogspot.com">Electric Duncan</a></li>
              <li><a href="http://blog.lfe.io/">LFE Blog</a></li>
              <li><a href="http://clojang.lfe.io/">Clojang</a></li>
              <li><a href="https://clozhang.github.io/blog/">Clozhang</a></li>
            </ul>

          </div>
          <div class="col-lg-6">
            <ul class="list-unstyled">
              <li class="float-lg-right text-muted">Github orgs</li>
              <li class="float-lg-right"><a href="https://github.com/erlsci">erlsci</a></li>
              <li class="float-lg-right"><a href="https://github.com/lfex">lfex</a></li>
              <li class="float-lg-right"><a href="https://github.com/clozhang">clozhang</a></li>
              <li class="float-lg-right"><a href="https://github.com/clojang">clojang</a></li>
              <li class="float-lg-right"><a href="https://github.com/clojusc">clojusc</a></li>
              <li class="float-lg-right"><a href="https://github.com/hexagram30">hexagram30</a></li>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-6">
          </div>
          <div class="col-lg-6">
            <ul class="list-unstyled">

              <li class="float-lg-right"><a href="https://github.com/masteringmatplotlib">masteringmatplotlib</a></li>
              <li class="float-lg-right"><a href="https://github.com/usgs-lcmap">usgs-lcmap</a></li>
              <li class="float-lg-right"><a href="https://github.com/nasa-ngap-archives">nasa-ngap-archives</a></li>
              <li class="float-lg-right"><a href="https://github.com/nasa-cmr-archives">nasa-cmr-archives</a></li>

            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-12">
            <p><a href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png">
            </a></p>
            <p class="text-muted">Content released under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License.</a>.</p>
            <p class="text-muted">Copyright &copy; Duncan McGreggor, 2003-2019</p>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-12">
            <p class="text-muted">Design adapted from the Bootswatch
              <a href="https://bootswatch.com/darkly/">Darkly</a> theme.
            </p>
          </div>
        </div>


    </footer>
    
    
    <script src="/blog/assets/jquery/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/popper.js/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/bootstrap/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/bootswatch/js/custom.js" crossorigin="anonymous"></script>
    <script src="/blog/assets/highlightjs/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
  
  </body>
</html>
